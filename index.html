<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masterizador Pro - Procesamiento Real de Audio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/wavesurfer.js@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=ATKfk7d4rzjz_fHEyNcMlIDgsD48zpAXpghL4tmJs_fbdlQlo9NTf96tgS-KJioAkatXlEaWXWYODmKE&vault=true&intent=subscription&currency=USD"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --dark: #0f172a;
            --darker: #020617;
            --light: #f8fafc;
            --gray: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(99, 102, 241, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo i {
            font-size: 2rem;
        }

        nav {
            display: flex;
            gap: 2rem;
        }

        nav a {
            color: var(--light);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        nav a:hover {
            background: rgba(99, 102, 241, 0.2);
            transform: translateY(-2px);
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .subscription-badge {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            padding: 2rem 0;
        }

        /* Upload Section */
        .upload-section {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .upload-area {
            border: 3px dashed var(--primary);
            border-radius: 15px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .upload-area:hover {
            background: rgba(99, 102, 241, 0.1);
            transform: translateY(-5px);
        }

        .upload-area i {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .file-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
        }

        /* Waveform */
        .waveform-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 1rem;
            margin: 2rem 0;
        }

        #waveform {
            height: 200px;
            border-radius: 10px;
            cursor: pointer;
        }

        /* Controls */
        .processing-controls {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(99, 102, 241, 0.2);
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .control-group {
            margin-bottom: 2rem;
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .control-header h3 {
            color: var(--light);
            font-size: 1.1rem;
        }

        .value-display {
            color: var(--primary);
            font-weight: bold;
            background: rgba(99, 102, 241, 0.1);
            padding: 0.3rem 0.8rem;
            border-radius: 10px;
        }

        .slider-container {
            margin-bottom: 1rem;
        }

        .slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 2rem;
        }

        .preset-btn {
            padding: 0.8rem;
            border: 1px solid rgba(99, 102, 241, 0.3);
            background: rgba(15, 23, 42, 0.5);
            color: var(--light);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .preset-btn:hover {
            background: rgba(99, 102, 241, 0.2);
            transform: translateY(-2px);
        }

        .preset-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            gap: 1rem;
        }

        .btn {
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #34d399);
            color: white;
        }

        /* Analysis Panel */
        .analysis-panel {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }

        .analysis-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }

        .analysis-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-top: 0.5rem;
        }

        /* Progress */
        .progress-container {
            margin: 2rem 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Results */
        .results-section {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 20px;
            padding: 2rem;
            margin-top: 2rem;
            border: 1px solid rgba(99, 102, 241, 0.2);
            display: none;
        }

        .results-section.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .comparison {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
            margin: 2rem 0;
        }

        .audio-player {
            width: 100%;
            margin-top: 1rem;
        }

        /* Paypal */
        .paypal-section {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            border: 1px solid rgba(99, 102, 241, 0.2);
            text-align: center;
        }

        /* Footer */
        footer {
            background: rgba(15, 23, 42, 0.9);
            padding: 3rem 0;
            margin-top: 4rem;
            border-top: 1px solid rgba(99, 102, 241, 0.3);
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
        }

        .footer-section h3 {
            color: var(--light);
            margin-bottom: 1.5rem;
        }

        .footer-section a {
            color: var(--gray);
            text-decoration: none;
            display: block;
            margin-bottom: 0.8rem;
            transition: color 0.3s ease;
        }

        .footer-section a:hover {
            color: var(--primary);
        }

        .social-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .social-links a {
            color: var(--light);
            font-size: 1.5rem;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--dark);
            border-radius: 20px;
            padding: 3rem;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(99, 102, 241, 0.3);
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: var(--light);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .processing-controls {
                position: static;
            }
            
            .footer-content {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            nav {
                gap: 0.5rem;
            }
            
            .comparison {
                grid-template-columns: 1fr;
            }
            
            .footer-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-wave-square"></i>
                    <span>Masterizador Pro</span>
                </div>
                <nav>
                    <a href="#upload"><i class="fas fa-upload"></i> Subir Audio</a>
                    <a href="#process"><i class="fas fa-sliders-h"></i> Procesar</a>
                    <a href="#results"><i class="fas fa-chart-bar"></i> Resultados</a>
                </nav>
                <div class="user-status">
                    <span class="subscription-badge" id="subscription-status">
                        <i class="fas fa-crown"></i> Pro
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="main-content">
            <!-- Left Column: Upload and Waveform -->
            <div class="left-column">
                <section id="upload" class="upload-section">
                    <h2><i class="fas fa-cloud-upload-alt"></i> Sube tu Audio</h2>
                    <p>Sube tu track en formato WAV, MP3, FLAC, OGG o M4A</p>
                    
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-file-audio"></i>
                        <h3>Arrastra y suelta tu archivo aquí</h3>
                        <p>o haz clic para seleccionar</p>
                        <input type="file" id="audioInput" accept="audio/*" style="display: none;">
                    </div>
                    
                    <div class="file-info" id="fileInfo" style="display: none;">
                        <div class="file-details">
                            <p><strong>Archivo:</strong> <span id="fileName"></span></p>
                            <p><strong>Tamaño:</strong> <span id="fileSize"></span></p>
                            <p><strong>Duración:</strong> <span id="fileDuration"></span></p>
                            <p><strong>Sample Rate:</strong> <span id="fileSampleRate"></span> Hz</p>
                        </div>
                    </div>

                    <div class="waveform-container">
                        <h3><i class="fas fa-waveform-lines"></i> Visualización del Audio</h3>
                        <div id="waveform"></div>
                        <div class="waveform-controls" style="margin-top: 1rem;">
                            <button id="playBtn" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                                <i class="fas fa-play"></i> Reproducir
                            </button>
                            <button id="pauseBtn" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                                <i class="fas fa-pause"></i> Pausar
                            </button>
                            <button id="stopBtn" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                                <i class="fas fa-stop"></i> Detener
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Results Section -->
                <section id="results" class="results-section">
                    <h2><i class="fas fa-chart-line"></i> Resultados de la Masterización</h2>
                    <div class="comparison">
                        <div class="original">
                            <h3><i class="fas fa-volume-down"></i> Original</h3>
                            <div id="waveformOriginal"></div>
                            <audio id="originalAudio" class="audio-player" controls></audio>
                            <div class="analysis-item">
                                <p>LUFS Original: <span id="originalLufs" class="analysis-value">--</span></p>
                            </div>
                        </div>
                        <div class="mastered">
                            <h3><i class="fas fa-volume-up"></i> Masterizado</h3>
                            <div id="waveformMastered"></div>
                            <audio id="masteredAudio" class="audio-player" controls></audio>
                            <div class="analysis-item">
                                <p>LUFS Masterizado: <span id="masteredLufs" class="analysis-value">--</span></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button id="downloadBtn" class="btn btn-success">
                            <i class="fas fa-download"></i> Descargar Audio Masterizado
                        </button>
                        <button id="resetBtn" class="btn btn-secondary">
                            <i class="fas fa-redo"></i> Procesar Otro Audio
                        </button>
                    </div>
                </section>
            </div>

            <!-- Right Column: Processing Controls -->
            <div class="right-column">
                <section id="process" class="processing-controls">
                    <h2><i class="fas fa-sliders-h"></i> Controles de Masterización</h2>
                    
                    <!-- Presets -->
                    <div class="control-group">
                        <h3><i class="fas fa-prescription-bottle"></i> Presets</h3>
                        <div class="preset-buttons">
                            <button class="preset-btn active" data-preset="streaming">
                                <i class="fas fa-stream"></i> Streaming
                            </button>
                            <button class="preset-btn" data-preset="club">
                                <i class="fas fa-music"></i> Club
                            </button>
                            <button class="preset-btn" data-preset="radio">
                                <i class="fas fa-broadcast-tower"></i> Radio
                            </button>
                            <button class="preset-btn" data-preset="vinyl">
                                <i class="fas fa-record-vinyl"></i> Vinyl
                            </button>
                            <button class="preset-btn" data-preset="loud">
                                <i class="fas fa-volume-up"></i> Loud
                            </button>
                            <button class="preset-btn" data-preset="dynamic">
                                <i class="fas fa-wave-square"></i> Dynamic
                            </button>
                        </div>
                    </div>

                    <!-- Loudness Control -->
                    <div class="control-group">
                        <div class="control-header">
                            <h3><i class="fas fa-volume-up"></i> Loudness Target</h3>
                            <span class="value-display" id="loudnessValue">-14 LUFS</span>
                        </div>
                        <div class="slider-container">
                            <input type="range" min="-20" max="-8" value="-14" step="0.5" 
                                   class="slider" id="loudnessSlider">
                        </div>
                        <p style="color: var(--gray); font-size: 0.9rem;">
                            Streaming: -14 LUFS • Radio: -9 LUFS • Club: -6 LUFS
                        </p>
                    </div>

                    <!-- EQ Controls -->
                    <div class="control-group">
                        <h3><i class="fas fa-sliders-h"></i> Ecualización</h3>
                        
                        <div class="slider-container">
                            <label>Bajos (60Hz)</label>
                            <input type="range" min="-12" max="12" value="0" step="0.5" 
                                   class="slider" id="bassSlider">
                            <span class="value-display" style="display: inline-block; margin-top: 5px;" 
                                  id="bassValue">0 dB</span>
                        </div>
                        
                        <div class="slider-container">
                            <label>Medios (1kHz)</label>
                            <input type="range" min="-12" max="12" value="0" step="0.5" 
                                   class="slider" id="midSlider">
                            <span class="value-display" style="display: inline-block; margin-top: 5px;" 
                                  id="midValue">0 dB</span>
                        </div>
                        
                        <div class="slider-container">
                            <label>Agudos (10kHz)</label>
                            <input type="range" min="-12" max="12" value="0" step="0.5" 
                                   class="slider" id="trebleSlider">
                            <span class="value-display" style="display: inline-block; margin-top: 5px;" 
                                  id="trebleValue">0 dB</span>
                        </div>
                    </div>

                    <!-- Compression -->
                    <div class="control-group">
                        <div class="control-header">
                            <h3><i class="fas fa-compress-arrows-alt"></i> Compresión</h3>
                            <span class="value-display" id="compressionValue">4:1</span>
                        </div>
                        <div class="slider-container">
                            <input type="range" min="1" max="20" value="4" step="0.1" 
                                   class="slider" id="compressionSlider">
                        </div>
                    </div>

                    <!-- Limiter -->
                    <div class="control-group">
                        <div class="control-header">
                            <h3><i class="fas fa-shield-alt"></i> Limitador</h3>
                            <span class="value-display" id="limiterValue">-1 dB</span>
                        </div>
                        <div class="slider-container">
                            <input type="range" min="-6" max="0" value="-1" step="0.1" 
                                   class="slider" id="limiterSlider">
                        </div>
                    </div>

                    <!-- Stereo Width -->
                    <div class="control-group">
                        <div class="control-header">
                            <h3><i class="fas fa-arrows-alt-h"></i> Ancho Estéreo</h3>
                            <span class="value-display" id="stereoValue">100%</span>
                        </div>
                        <div class="slider-container">
                            <input type="range" min="50" max="150" value="100" step="1" 
                                   class="slider" id="stereoSlider">
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button id="processBtn" class="btn btn-primary">
                            <i class="fas fa-magic"></i> Masterizar Ahora
                        </button>
                        <button id="analyzeBtn" class="btn btn-secondary">
                            <i class="fas fa-chart-bar"></i> Analizar Audio
                        </button>
                    </div>

                    <!-- Progress -->
                    <div class="progress-container" id="progressContainer">
                        <h3><i class="fas fa-cogs"></i> Procesando...</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <p id="progressText">Inicializando...</p>
                    </div>

                    <!-- Analysis Results -->
                    <div class="analysis-panel" id="analysisPanel" style="display: none;">
                        <div class="analysis-item">
                            <p><i class="fas fa-volume-up"></i> LUFS</p>
                            <div class="analysis-value" id="analysisLufs">-14.2</div>
                        </div>
                        <div class="analysis-item">
                            <p><i class="fas fa-wave-square"></i> Peak</p>
                            <div class="analysis-value" id="analysisPeak">-0.5 dB</div>
                        </div>
                        <div class="analysis-item">
                            <p><i class="fas fa-ruler"></i> Dynamic Range</p>
                            <div class="analysis-value" id="analysisDynamic">8.5 dB</div>
                        </div>
                        <div class="analysis-item">
                            <p><i class="fas fa-balance-scale"></i> Balance</p>
                            <div class="analysis-value" id="analysisBalance">0.2%</div>
                        </div>
                    </div>
                </section>

                <!-- PayPal Section -->
                <section class="paypal-section">
                    <h3><i class="fab fa-paypal"></i> Suscripción Premium</h3>
                    <p>Desbloquea todas las funciones por solo $10/mes</p>
                    <div id="paypal-button-container"></div>
                    <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--gray);">
                        <i class="fas fa-lock"></i> Pago seguro • Sin contratos • Cancelación instantánea
                    </p>
                </section>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Masterizador Pro</h3>
                    <p>Herramienta profesional de masterización de audio en el navegador.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-github"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                        <a href="#"><i class="fab fa-discord"></i></a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>Recursos</h3>
                    <a href="#">Documentación</a>
                    <a href="#">API para Desarrolladores</a>
                    <a href="#">Ejemplos de Audio</a>
                    <a href="#">Guías de Masterización</a>
                </div>
                <div class="footer-section">
                    <h3>Soporte</h3>
                    <a href="#">Centro de Ayuda</a>
                    <a href="#">Comunidad</a>
                    <a href="#">Contacto</a>
                    <a href="#">Reportar Problema</a>
                </div>
                <div class="footer-section">
                    <h3>Legal</h3>
                    <a href="#">Términos de Servicio</a>
                    <a href="#">Política de Privacidad</a>
                    <a href="#">Cookies</a>
                    <a href="#">Licencias</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Subscription Modal -->
    <div class="modal" id="subscriptionModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2><i class="fas fa-crown"></i> Suscripción Requerida</h2>
            <p>Para acceder a todas las funciones de masterización profesional, necesitas una suscripción premium.</p>
            <div id="paypal-modal-container" style="margin: 2rem 0;"></div>
            <p style="color: var(--gray); font-size: 0.9rem;">
                La suscripción incluye: procesamiento ilimitado, análisis avanzado, exportación en alta calidad, y soporte prioritario.
            </p>
        </div>
    </div>

    <!-- Script -->
    <script>
        // Variables globales
        let audioContext = null;
        let audioBuffer = null;
        let originalAudioBuffer = null;
        let wavesurfer = null;
        let wavesurferOriginal = null;
        let wavesurferMastered = null;
        let isSubscribed = true; // Cambiar a false para requerir suscripción
        let currentPreset = 'streaming';
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            initWaveSurfer();
            initPayPal();
            initEventListeners();
            loadPreset('streaming');
        });
        
        function initApp() {
            // Verificar suscripción en localStorage
            const savedSubscription = localStorage.getItem('masterpro_subscribed');
            if (savedSubscription === 'true') {
                isSubscribed = true;
                updateSubscriptionStatus();
            }
            
            // Inicializar AudioContext
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Verificar compatibilidad
            if (!audioContext) {
                alert('Tu navegador no soporta Web Audio API. Por favor, usa Chrome, Firefox o Edge.');
            }
        }
        
        function initWaveSurfer() {
            // WaveSurfer para el audio original
            wavesurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: '#4f46e5',
                progressColor: '#ec4899',
                cursorColor: '#ffffff',
                barWidth: 2,
                barRadius: 3,
                cursorWidth: 1,
                height: 200,
                barGap: 3,
                responsive: true
            });
            
            wavesurfer.on('ready', function() {
                document.getElementById('playBtn').style.display = 'inline-block';
            });
            
            wavesurfer.on('finish', function() {
                document.getElementById('playBtn').innerHTML = '<i class="fas fa-play"></i> Reproducir';
            });
            
            // Inicializar controles de reproducción
            document.getElementById('playBtn').addEventListener('click', function() {
                wavesurfer.playPause();
                const icon = wavesurfer.isPlaying() ? 'fa-pause' : 'fa-play';
                this.innerHTML = `<i class="fas ${icon}"></i> ${wavesurfer.isPlaying() ? 'Pausar' : 'Reproducir'}`;
            });
            
            document.getElementById('pauseBtn').addEventListener('click', function() {
                wavesurfer.pause();
                document.getElementById('playBtn').innerHTML = '<i class="fas fa-play"></i> Reproducir';
            });
            
            document.getElementById('stopBtn').addEventListener('click', function() {
                wavesurfer.stop();
                document.getElementById('playBtn').innerHTML = '<i class="fas fa-play"></i> Reproducir';
            });
        }
        
        function initPayPal() {
            paypal.Buttons({
                style: {
                    shape: 'pill',
                    color: 'blue',
                    layout: 'vertical',
                    label: 'subscribe'
                },
                createSubscription: function(data, actions) {
                    return actions.subscription.create({
                        plan_id: 'P-3ML32445H2853452WMIEUXSI' // Reemplazar con ID real
                    });
                },
                onApprove: function(data, actions) {
                    showNotification('¡Suscripción exitosa!', 'success');
                    isSubscribed = true;
                    localStorage.setItem('masterpro_subscribed', 'true');
                    updateSubscriptionStatus();
                    closeModal();
                },
                onError: function(err) {
                    console.error('PayPal error:', err);
                    showNotification('Error en el pago. Intenta nuevamente.', 'error');
                }
            }).render('#paypal-button-container');
            
            // También para el modal
            paypal.Buttons({
                style: {
                    shape: 'pill',
                    color: 'gold',
                    layout: 'vertical',
                    label: 'subscribe'
                },
                createSubscription: function(data, actions) {
                    return actions.subscription.create({
                        plan_id: 'P-3ML32445H2853452WMIEUXSI'
                    });
                },
                onApprove: function(data, actions) {
                    showNotification('¡Suscripción exitosa!', 'success');
                    isSubscribed = true;
                    localStorage.setItem('masterpro_subscribed', 'true');
                    updateSubscriptionStatus();
                    closeModal();
                }
            }).render('#paypal-modal-container');
        }
        
        function initEventListeners() {
            // Upload
            const uploadArea = document.getElementById('uploadArea');
            const audioInput = document.getElementById('audioInput');
            
            uploadArea.addEventListener('click', () => audioInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#10b981';
                uploadArea.style.transform = 'scale(1.02)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#6366f1';
                uploadArea.style.transform = 'scale(1)';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#6366f1';
                uploadArea.style.transform = 'scale(1)';
                
                if (e.dataTransfer.files.length) {
                    audioInput.files = e.dataTransfer.files;
                    handleAudioFile(e.dataTransfer.files[0]);
                }
            });
            
            audioInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleAudioFile(e.target.files[0]);
                }
            });
            
            // Sliders
            const sliders = document.querySelectorAll('.slider');
            sliders.forEach(slider => {
                slider.addEventListener('input', updateSliderValue);
            });
            
            // Presets
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const preset = this.dataset.preset;
                    loadPreset(preset);
                });
            });
            
            // Buttons
            document.getElementById('processBtn').addEventListener('click', processAudio);
            document.getElementById('analyzeBtn').addEventListener('click', analyzeAudio);
            document.getElementById('downloadBtn').addEventListener('click', downloadMasteredAudio);
            document.getElementById('resetBtn').addEventListener('click', resetApp);
            
            // Update slider values on load
            updateSliderValue();
        }
        
        async function handleAudioFile(file) {
            if (!file.type.includes('audio')) {
                showNotification('Por favor, sube un archivo de audio válido', 'error');
                return;
            }
            
            if (file.size > 100 * 1024 * 1024) {
                showNotification('El archivo es demasiado grande (máximo 100MB)', 'error');
                return;
            }
            
            showNotification('Cargando archivo de audio...', 'info');
            
            try {
                // Mostrar información del archivo
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatFileSize(file.size);
                
                // Cargar y decodificar el audio
                const arrayBuffer = await file.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                originalAudioBuffer = audioBuffer; // Guardar copia original
                
                // Actualizar información
                document.getElementById('fileDuration').textContent = 
                    formatDuration(audioBuffer.duration);
                document.getElementById('fileSampleRate').textContent = 
                    audioBuffer.sampleRate.toLocaleString();
                
                // Cargar en WaveSurfer
                const blob = new Blob([arrayBuffer], { type: file.type });
                const url = URL.createObjectURL(blob);
                wavesurfer.load(url);
                
                // Habilitar botón de procesamiento
                document.getElementById('processBtn').disabled = false;
                document.getElementById('analyzeBtn').disabled = false;
                
                // Mostrar sección de resultados si estaba oculta
                document.getElementById('results').classList.remove('show');
                
                showNotification('Archivo cargado exitosamente', 'success');
                
                // Analizar automáticamente
                setTimeout(analyzeAudio, 500);
                
            } catch (error) {
                console.error('Error loading audio:', error);
                showNotification('Error al cargar el archivo de audio', 'error');
            }
        }
        
        async function processAudio() {
            if (!audioBuffer) {
                showNotification('Por favor, sube un archivo de audio primero', 'error');
                return;
            }
            
            if (!isSubscribed) {
                document.getElementById('subscriptionModal').classList.add('show');
                return;
            }
            
            showProgress(true);
            
            try {
                // Crear contexto offline para procesamiento
                const offlineContext = new OfflineAudioContext(
                    audioBuffer.numberOfChannels,
                    audioBuffer.length,
                    audioBuffer.sampleRate
                );
                
                // Crear nodos de procesamiento
                const source = offlineContext.createBufferSource();
                source.buffer = audioBuffer;
                
                // Obtener valores de controles
                const loudnessTarget = parseFloat(document.getElementById('loudnessSlider').value);
                const bassGain = parseFloat(document.getElementById('bassSlider').value);
                const midGain = parseFloat(document.getElementById('midSlider').value);
                const trebleGain = parseFloat(document.getElementById('trebleSlider').value);
                const compressionRatio = parseFloat(document.getElementById('compressionSlider').value);
                const limiterThreshold = parseFloat(document.getElementById('limiterSlider').value);
                const stereoWidth = parseFloat(document.getElementById('stereoSlider').value) / 100;
                
                // Crear cadena de efectos
                const splitter = offlineContext.createChannelSplitter(2);
                const merger = offlineContext.createChannelMerger(2);
                
                // EQ - Filtros
                const bassFilter = offlineContext.createBiquadFilter();
                bassFilter.type = 'lowshelf';
                bassFilter.frequency.value = 120;
                bassFilter.gain.value = bassGain;
                
                const midFilter = offlineContext.createBiquadFilter();
                midFilter.type = 'peaking';
                midFilter.frequency.value = 1000;
                midFilter.Q.value = 1;
                midFilter.gain.value = midGain;
                
                const trebleFilter = offlineContext.createBiquadFilter();
                trebleFilter.type = 'highshelf';
                trebleFilter.frequency.value = 6000;
                trebleFilter.gain.value = trebleGain;
                
                // Compresor
                const compressor = offlineContext.createDynamicsCompressor();
                compressor.threshold.value = -24;
                compressor.knee.value = 30;
                compressor.ratio.value = compressionRatio;
                compressor.attack.value = 0.003;
                compressor.release.value = 0.25;
                
                // Limitador
                const limiter = offlineContext.createDynamicsCompressor();
                limiter.threshold.value = limiterThreshold;
                limiter.knee.value = 0;
                limiter.ratio.value = 20;
                limiter.attack.value = 0.001;
                limiter.release.value = 0.05;
                
                // Ganancia para loudness
                const gainNode = offlineContext.createGain();
                
                // Ancho estéreo (mid-side processing simplificado)
                if (stereoWidth !== 1) {
                    // Solo procesar si hay diferencia
                    const widthGain = offlineContext.createGain();
                    widthGain.gain.value = stereoWidth;
                }
                
                // Conectar nodos
                source.connect(bassFilter);
                bassFilter.connect(midFilter);
                midFilter.connect(trebleFilter);
                trebleFilter.connect(compressor);
                compressor.connect(limiter);
                limiter.connect(gainNode);
                
                // Si es estéreo, procesar canales
                if (audioBuffer.numberOfChannels === 2) {
                    gainNode.connect(splitter);
                    splitter.connect(merger, 0, 0);
                    splitter.connect(merger, 1, 1);
                    merger.connect(offlineContext.destination);
                } else {
                    gainNode.connect(offlineContext.destination);
                }
                
                // Iniciar procesamiento
                source.start(0);
                
                // Renderizar
                updateProgress('Procesando audio...', 30);
                const renderedBuffer = await offlineContext.startRendering();
                
                updateProgress('Aplicando normalización LUFS...', 60);
                
                // Calcular y ajustar loudness
                const loudness = await calculateLoudness(renderedBuffer);
                const loudnessDifference = loudnessTarget - loudness;
                
                // Ajustar ganancia para target LUFS
                const targetGain = Math.pow(10, loudnessDifference / 20);
                
                // Aplicar ganancia
                const finalContext = new OfflineAudioContext(
                    renderedBuffer.numberOfChannels,
                    renderedBuffer.length,
                    renderedBuffer.sampleRate
                );
                
                const finalSource = finalContext.createBufferSource();
                finalSource.buffer = renderedBuffer;
                
                const finalGain = finalContext.createGain();
                finalGain.gain.value = Math.min(targetGain, Math.pow(10, -limiterThreshold / 20));
                
                finalSource.connect(finalGain);
                finalGain.connect(finalContext.destination);
                
                finalSource.start(0);
                
                updateProgress('Finalizando...', 90);
                const finalBuffer = await finalContext.startRendering();
                
                // Actualizar audio buffer masterizado
                audioBuffer = finalBuffer;
                
                // Crear blob para reproducción
                const wavBlob = audioBufferToWav(finalBuffer);
                const masteredUrl = URL.createObjectURL(wavBlob);
                
                // Mostrar resultados
                showResults(masteredUrl, loudness);
                
                updateProgress('¡Masterización completada!', 100);
                
                setTimeout(() => {
                    showProgress(false);
                    showNotification('¡Audio masterizado exitosamente!', 'success');
                }, 500);
                
            } catch (error) {
                console.error('Error processing audio:', error);
                showProgress(false);
                showNotification('Error al procesar el audio', 'error');
            }
        }
        
        async function analyzeAudio() {
            if (!audioBuffer) {
                showNotification('Por favor, sube un archivo de audio primero', 'error');
                return;
            }
            
            try {
                // Calcular métricas
                const loudness = await calculateLoudness(audioBuffer);
                const peak = await calculatePeak(audioBuffer);
                const dynamicRange = await calculateDynamicRange(audioBuffer);
                const balance = await calculateStereoBalance(audioBuffer);
                
                // Mostrar resultados
                document.getElementById('analysisLufs').textContent = loudness.toFixed(1);
                document.getElementById('analysisPeak').textContent = peak.toFixed(1) + ' dB';
                document.getElementById('analysisDynamic').textContent = dynamicRange.toFixed(1) + ' dB';
                document.getElementById('analysisBalance').textContent = balance.toFixed(1) + '%';
                
                document.getElementById('analysisPanel').style.display = 'grid';
                
                showNotification('Análisis completado', 'success');
                
            } catch (error) {
                console.error('Error analyzing audio:', error);
                showNotification('Error al analizar el audio', 'error');
            }
        }
        
        function showResults(masteredUrl, originalLoudness) {
            // Mostrar sección de resultados
            const resultsSection = document.getElementById('results');
            resultsSection.classList.add('show');
            
            // Crear URL para audio original
            const originalBlob = audioBufferToWav(originalAudioBuffer);
            const originalUrl = URL.createObjectURL(originalBlob);
            
            // Configurar audios
            document.getElementById('originalAudio').src = originalUrl;
            document.getElementById('masteredAudio').src = masteredUrl;
            
            // Calcular LUFS masterizado
            calculateLoudness(audioBuffer).then(masteredLoudness => {
                document.getElementById('originalLufs').textContent = originalLoudness.toFixed(1);
                document.getElementById('masteredLufs').textContent = masteredLoudness.toFixed(1);
            });
            
            // Inicializar WaveSurfer para comparación
            if (!wavesurferOriginal) {
                wavesurferOriginal = WaveSurfer.create({
                    container: '#waveformOriginal',
                    waveColor: '#64748b',
                    progressColor: '#94a3b8',
                    height: 100,
                    barWidth: 1,
                    responsive: true
                });
            }
            
            if (!wavesurferMastered) {
                wavesurferMastered = WaveSurfer.create({
                    container: '#waveformMastered',
                    waveColor: '#10b981',
                    progressColor: '#34d399',
                    height: 100,
                    barWidth: 1,
                    responsive: true
                });
            }
            
            wavesurferOriginal.load(originalUrl);
            wavesurferMastered.load(masteredUrl);
            
            // Scroll a resultados
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        function downloadMasteredAudio() {
            if (!audioBuffer) {
                showNotification('No hay audio para descargar', 'error');
                return;
            }
            
            const wavBlob = audioBufferToWav(audioBuffer);
            const url = URL.createObjectURL(wavBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `mastered_${Date.now()}.wav`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            
            showNotification('Descarga iniciada', 'success');
        }
        
        // Funciones de análisis de audio
        async function calculateLoudness(buffer) {
            // Implementación simplificada de cálculo LUFS
            // En producción, usar librería como "loudness"
            const channelData = buffer.getChannelData(0);
            let sum = 0;
            
            // Tomar muestras cada 100ms para simular
            const sampleRate = buffer.sampleRate;
            const samplesPerWindow = Math.floor(sampleRate * 0.1);
            const windows = Math.floor(channelData.length / samplesPerWindow);
            
            for (let i = 0; i < windows; i++) {
                let windowSum = 0;
                const start = i * samplesPerWindow;
                const end = start + samplesPerWindow;
                
                for (let j = start; j < end && j < channelData.length; j++) {
                    windowSum += channelData[j] * channelData[j];
                }
                
                const rms = Math.sqrt(windowSum / samplesPerWindow);
                const loudness = 20 * Math.log10(rms);
                
                if (loudness > -70) { // Gate de -70 LUFS
                    sum += Math.pow(10, loudness / 10);
                }
            }
            
            const average = sum / windows;
            return 10 * Math.log10(average);
        }
        
        async function calculatePeak(buffer) {
            let peak = 0;
            for (let channel = 0; channel < buffer.numberOfChannels; channel++) {
                const channelData = buffer.getChannelData(channel);
                for (let i = 0; i < channelData.length; i++) {
                    const absValue = Math.abs(channelData[i]);
                    if (absValue > peak) {
                        peak = absValue;
                    }
                }
            }
            return 20 * Math.log10(peak);
        }
        
        async function calculateDynamicRange(buffer) {
            const loudness = await calculateLoudness(buffer);
            const peak = await calculatePeak(buffer);
            return peak - loudness;
        }
        
        async function calculateStereoBalance(buffer) {
            if (buffer.numberOfChannels < 2) return 0;
            
            const left = buffer.getChannelData(0);
            const right = buffer.getChannelData(1);
            
            let leftSum = 0;
            let rightSum = 0;
            
            for (let i = 0; i < left.length; i += 100) {
                leftSum += Math.abs(left[i]);
                rightSum += Math.abs(right[i]);
            }
            
            const balance = ((leftSum - rightSum) / ((leftSum + rightSum) / 2)) * 100;
            return Math.abs(balance);
        }
        
        // Funciones auxiliares
        function audioBufferToWav(buffer) {
            const numChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const length = buffer.length * numChannels * 2;
            const bufferArray = new ArrayBuffer(44 + length);
            const view = new DataView(bufferArray);
            
            // Escribir encabezado WAV
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + length, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * 2, true);
            view.setUint16(32, numChannels * 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, length, true);
            
            // Escribir datos de audio
            const offset = 44;
            const channels = [];
            
            for (let i = 0; i < numChannels; i++) {
                channels.push(buffer.getChannelData(i));
            }
            
            let index = 0;
            for (let i = 0; i < buffer.length; i++) {
                for (let channel = 0; channel < numChannels; channel++) {
                    const sample = Math.max(-1, Math.min(1, channels[channel][i]));
                    view.setInt16(offset + index, sample * 0x7FFF, true);
                    index += 2;
                }
            }
            
            return new Blob([bufferArray], { type: 'audio/wav' });
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }
        
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function updateSliderValue() {
            document.getElementById('loudnessValue').textContent = 
                document.getElementById('loudnessSlider').value + ' LUFS';
            
            document.getElementById('bassValue').textContent = 
                document.getElementById('bassSlider').value + ' dB';
            
            document.getElementById('midValue').textContent = 
                document.getElementById('midSlider').value + ' dB';
            
            document.getElementById('trebleValue').textContent = 
                document.getElementById('trebleSlider').value + ' dB';
            
            document.getElementById('compressionValue').textContent = 
                document.getElementById('compressionSlider').value + ':1';
            
            document.getElementById('limiterValue').textContent = 
                document.getElementById('limiterSlider').value + ' dB';
            
            document.getElementById('stereoValue').textContent = 
                document.getElementById('stereoSlider').value + '%';
        }
        
        function loadPreset(preset) {
            currentPreset = preset;
            
            const presets = {
                streaming: {
                    loudness: -14,
                    bass: 0,
                    mid: 0,
                    treble: 1,
                    compression: 4,
                    limiter: -1,
                    stereo: 100
                },
                club: {
                    loudness: -6,
                    bass: 3,
                    mid: 1,
                    treble: 2,
                    compression: 6,
                    limiter: -0.5,
                    stereo: 110
                },
                radio: {
                    loudness: -9,
                    bass: 1,
                    mid: 2,
                    treble: 1,
                    compression: 5,
                    limiter: -1,
                    stereo: 100
                },
                vinyl: {
                    loudness: -12,
                    bass: -2,
                    mid: 1,
                    treble: -1,
                    compression: 3,
                    limiter: -2,
                    stereo: 95
                },
                loud: {
                    loudness: -8,
                    bass: 2,
                    mid: 0,
                    treble: 3,
                    compression: 8,
                    limiter: -0.3,
                    stereo: 105
                },
                dynamic: {
                    loudness: -16,
                    bass: 0,
                    mid: 0,
                    treble: 0,
                    compression: 2,
                    limiter: -3,
                    stereo: 100
                }
            };
            
            const p = presets[preset];
            if (!p) return;
            
            document.getElementById('loudnessSlider').value = p.loudness;
            document.getElementById('bassSlider').value = p.bass;
            document.getElementById('midSlider').value = p.mid;
            document.getElementById('trebleSlider').value = p.treble;
            document.getElementById('compressionSlider').value = p.compression;
            document.getElementById('limiterSlider').value = p.limiter;
            document.getElementById('stereoSlider').value = p.stereo;
            
            updateSliderValue();
            
            showNotification(`Preset "${preset}" cargado`, 'info');
        }
        
        function showProgress(show) {
            const container = document.getElementById('progressContainer');
            if (show) {
                container.style.display = 'block';
                container.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                container.style.display = 'none';
            }
        }
        
        function updateProgress(text, percent) {
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressFill').style.width = percent + '%';
        }
        
        function updateSubscriptionStatus() {
            const status = document.getElementById('subscriptionStatus');
            if (isSubscribed) {
                status.innerHTML = '<i class="fas fa-crown"></i> Suscripción Pro';
                status.style.background = 'linear-gradient(45deg, #10b981, #34d399)';
            } else {
                status.innerHTML = '<i class="fas fa-lock"></i> Gratis';
                status.style.background = 'linear-gradient(45deg, #64748b, #94a3b8)';
            }
        }
        
        function resetApp() {
            // Resetear todo el estado
            audioBuffer = null;
            originalAudioBuffer = null;
            
            // Limpiar wave forms
            wavesurfer.empty();
            if (wavesurferOriginal) wavesurferOriginal.empty();
            if (wavesurferMastered) wavesurferMastered.empty();
            
            // Ocultar resultados
            document.getElementById('results').classList.remove('show');
            
            // Limpiar información del archivo
            document.getElementById('fileInfo').style.display = 'none';
            
            // Deshabilitar botones
            document.getElementById('processBtn').disabled = true;
            document.getElementById('analyzeBtn').disabled = true;
            
            // Ocultar análisis
            document.getElementById('analysisPanel').style.display = 'none';
            
            // Scroll al inicio
            document.getElementById('upload').scrollIntoView({ behavior: 'smooth' });
            
            showNotification('Aplicación reiniciada', 'info');
        }
        
        function showNotification(message, type = 'info') {
            // Crear notificación
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'success' ? '#10b981' : 
                           type === 'error' ? '#ef4444' : '#6366f1'};
                color: white;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: fadeIn 0.3s ease-out;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            
            notification.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Remover después de 5 segundos
            setTimeout(() => {
                notification.style.animation = 'fadeIn 0.3s reverse';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 5000);
        }
        
        function closeModal() {
            document.getElementById('subscriptionModal').classList.remove('show');
        }
        
        // Exponer funciones globales para botones HTML
        window.closeModal = closeModal;
    </script>
</body>
</html>
